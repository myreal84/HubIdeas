package com.dominikpetrich.hubideas

import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.viewModels
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.text.KeyboardActions
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material3.*
import androidx.compose.material3.ExperimentalMaterial3Api
import androidx.compose.runtime.*
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.input.ImeAction
import androidx.compose.ui.text.input.TextFieldValue
import androidx.compose.ui.unit.dp
import com.dominikpetrich.hubideas.ui.NoteViewModel
import com.dominikpetrich.hubideas.ui.NoteViewModelFactory
import com.dominikpetrich.hubideas.ui.ProjectViewModel
import com.dominikpetrich.hubideas.ui.ProjectViewModelFactory
import com.dominikpetrich.hubideas.data.local.entity.ProjectEntity
import kotlinx.coroutines.launch



class MainActivity : ComponentActivity() {
    private val noteVm by viewModels<NoteViewModel> { NoteViewModelFactory(applicationContext) }
    private val projectVm by viewModels<ProjectViewModel> { ProjectViewModelFactory(applicationContext) }
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContent { HubideasApp(noteVm, projectVm) }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun HubideasApp(noteVm: NoteViewModel, projectVm: ProjectViewModel) {
    val DarkColors = darkColorScheme(
        primary = Color(0xFF00C853), onPrimary = Color(0xFF001408),
        secondary = Color(0xFF1DE9B6), onSecondary = Color(0xFF001410),
        background = Color(0xFF0E1116), onBackground = Color(0xFFE6EAEF),
        surface = Color(0xFF12151B), onSurface = Color(0xFFF1F4F8)
    )
    MaterialTheme(colorScheme = DarkColors) {
        Scaffold(containerColor = DarkColors.background, topBar = { CenterAlignedTopAppBar(title = { Text("ideahub") }) }) { inner ->
            Box(Modifier.fillMaxSize().padding(inner)) { NotesScreen(noteVm, projectVm) }
        }
    }
}

@Composable
fun NotesScreen(noteVm: NoteViewModel, projectVm: ProjectViewModel) {
    var noteText by rememberSaveable(stateSaver = TextFieldValue.Saver) { mutableStateOf(TextFieldValue("")) }
    val notes by noteVm.notes.collectAsState()
    val projects by projectVm.projects.collectAsState()

    // Mapping projectId -> name for chip
    val projectNameOf by remember(projects) {
        mutableStateOf(projects.associate { it.id to it.name })
    }

    // Project picker state
    var pickerNoteId by remember { mutableStateOf<Long?>(null) }
    val scope = rememberCoroutineScope()

    Column(Modifier.fillMaxSize().padding(horizontal = 12.dp, vertical = 6.dp), horizontalAlignment = Alignment.CenterHorizontally) {
        Column(Modifier.widthIn(max = 620.dp).fillMaxWidth()) {
            Surface(shape = MaterialTheme.shapes.large, tonalElevation = 2.dp, modifier = Modifier.fillMaxWidth()) {
                Row(verticalAlignment = Alignment.CenterVertically, modifier = Modifier.padding(10.dp)) {
                    OutlinedTextField(
                        value = noteText, onValueChange = { noteText = it }, placeholder = { Text("Neue Notiz…") },
                        maxLines = 3, modifier = Modifier.weight(1f),
                        keyboardOptions = KeyboardOptions(imeAction = ImeAction.Done),
                        keyboardActions = KeyboardActions(onDone = { val t = noteText.text.trim(); if (t.isNotEmpty()) { noteVm.add(t); noteText = TextFieldValue("") } })
                    )
                    Spacer(Modifier.width(8.dp))
                    FilledTonalButton(onClick = { val t = noteText.text.trim(); if (t.isNotEmpty()) { noteVm.add(t); noteText = TextFieldValue("") } }) { Text("Hinzufügen") }
                }
            }
            Spacer(Modifier.height(12.dp))
            HorizontalDivider()
            Spacer(Modifier.height(6.dp))
            if (notes.isEmpty()) {
                Text("Noch keine Notizen. Füge oben eine hinzu.", color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.7f))
            } else {
                LazyColumn(Modifier.fillMaxSize(), verticalArrangement = Arrangement.spacedBy(8.dp)) {
                    items(notes, key = { it.id }) { item ->
                        val pname = projectNameOf[item.projectId] ?: "Inbox"
                        NoteRow(
                            text = item.content,
                            projectName = pname,
                            onRename = { newText -> noteVm.rename(item.id, newText) },
                            onChangeProject = { pickerNoteId = item.id },
                            onRemove = { noteVm.delete(item.id) }
                        )
                    }
                }
            }
        }
    }

    // Dialog for selecting/creating a project
    val currentNoteId = pickerNoteId
    if (currentNoteId != null) {
        ProjectPickerDialog(
            projects = projects,
            onSelect = { p ->
                scope.launch { noteVm.move(currentNoteId, p.id) }
                pickerNoteId = null
            },
            onCreate = { name ->
                scope.launch {
                    val id = projectVm.ensureProjectId(name)
                    noteVm.move(currentNoteId, id)
                    pickerNoteId = null
                }
            },
            onDismiss = { pickerNoteId = null }
        )
    }
}

@Composable
fun ProjectChip(name: String) {
    Surface(shape = MaterialTheme.shapes.small, tonalElevation = 1.dp) {
        Text(name, modifier = Modifier.padding(horizontal = 8.dp, vertical = 4.dp), style = MaterialTheme.typography.labelMedium)
    }
}

@Composable
fun ProjectPickerDialog(
    projects: List<ProjectEntity>,
    onSelect: (ProjectEntity) -> Unit,
    onCreate: (String) -> Unit,
    onDismiss: () -> Unit
) {
    var newName by rememberSaveable { mutableStateOf("") }
    AlertDialog(
        onDismissRequest = onDismiss,
        title = { Text("Projekt auswählen") },
        text = {
            Column(Modifier.fillMaxWidth()) {
                Box(Modifier.heightIn(max = 260.dp).fillMaxWidth()) {
                    LazyColumn(Modifier.fillMaxSize()) {
                        items(projects, key = { it.id }) { p ->
                            Row(Modifier.fillMaxWidth().clickable { onSelect(p) }.padding(vertical = 10.dp)) {
                                Text(p.name)
                            }
                        }
                    }
                }
                Spacer(Modifier.height(12.dp))
                OutlinedTextField(
                    value = newName,
                    onValueChange = { newName = it },
                    singleLine = true,
                    label = { Text("Neues Projekt") },
                    modifier = Modifier.fillMaxWidth()
                )
            }
        },
        confirmButton = {
            TextButton(onClick = { val t = newName.trim(); if (t.isNotEmpty()) onCreate(t) }, enabled = newName.trim().isNotEmpty()) { Text("Erstellen & zuordnen") }
        },
        dismissButton = { TextButton(onClick = onDismiss) { Text("Schließen") } }
    )
}

@Composable
fun NoteRow(
    text: String,
    projectName: String,
    onRename: (String) -> Unit,
    onChangeProject: () -> Unit,
    onRemove: () -> Unit
) {
    var menuExpanded by remember { mutableStateOf(false) }
    var showRename by remember { mutableStateOf(false) }
    var tempText by rememberSaveable(stateSaver = TextFieldValue.Saver) { mutableStateOf(TextFieldValue("")) }
    Surface(shape = MaterialTheme.shapes.large, tonalElevation = 2.dp, modifier = Modifier.fillMaxWidth()) {
        Column(Modifier.padding(12.dp)) {
            Row(verticalAlignment = Alignment.CenterVertically) {
                ProjectChip(projectName)
                Spacer(Modifier.width(8.dp))
                Text(text = text, modifier = Modifier.weight(1f))
                Box {
                    IconButton(onClick = { menuExpanded = true }) { Text("⋮", style = MaterialTheme.typography.titleLarge) }
                    DropdownMenu(expanded = menuExpanded, onDismissRequest = { menuExpanded = false }) {
                        DropdownMenuItem(text = { Text("Umbenennen") }, onClick = { tempText = TextFieldValue(text); menuExpanded = false; showRename = true })
                        DropdownMenuItem(text = { Text("Projekt ändern") }, onClick = { menuExpanded = false; onChangeProject() })
                        DropdownMenuItem(text = { Text("Löschen") }, onClick = { menuExpanded = false; onRemove() })
                    }
                }
            }
        }
    }
    if (showRename) {
        AlertDialog(
            onDismissRequest = { showRename = false },
            title = { Text("Notiz umbenennen") },
            text = { OutlinedTextField(value = tempText, onValueChange = { tempText = it }, modifier = Modifier.fillMaxWidth()) },
            confirmButton = { TextButton(onClick = { val t = tempText.text.trim(); if (t.isNotEmpty()) { onRename(t); showRename = false } }) { Text("Speichern") } },
            dismissButton = { TextButton(onClick = { showRename = false }) { Text("Abbrechen") } }
        )
    }
}
